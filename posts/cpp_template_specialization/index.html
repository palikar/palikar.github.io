<!DOCTYPE html>
<html lang="en-us" class="wf-firasans-n4-active wf-active">
	<head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">


<meta name="generator" content="Hugo 0.40.1" />

<title>C&#43;&#43; Template Specialization &middot; SA Dev</title>
<meta content="C&#43;&#43; Template Specialization - SA Dev" property="og:title">
<meta content=" - A short description of a solution to a github related problem with the email addresses associated with a commit historys" property="og:description">
<!-- CSS -->
<link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i" rel="stylesheet">
<link rel="stylesheet" href="https://palikar.github.io/css/print.css" media="print">
<link rel="stylesheet" href="https://palikar.github.io/css/poole.css">
<link rel="stylesheet" href="https://palikar.github.io/css/hyde.css">
<!-- Font-Awesome -->
<script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js" integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl" crossorigin="anonymous"></script>
<!-- highlight.js-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
<!-- Customised CSS -->
<link rel="stylesheet" href="https://palikar.github.io/css/custom.css">
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<!-- Icons -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.png">


	</head>
    <body>
        <div class="sidebar">
	<div class="container text-center sidebar-sticky">
		<div class="sidebar-about text-center">
			<a href="https://palikar.github.io/"><h1 class="brand">SA Dev</h1></a>
			 <img src="/img/profile.jpg" alt="Author Image" class="img-circle headshot center"> 
			<p class="lead">
				 Develompent, CS, AI and whatever my little heart desires 
			</p>
		</div>
		
<div>
	<ul class="sidebar-nav">
		
		
				<li>
					<a href="/"> <span>Home</span></a>
				</li>
				<li>
					<a href="/about/"> <span>About</span></a>
				</li>
				<li>
					<a href="/posts/"> <span>Blog Posts</span></a>
				</li>
				<li>
					<a href="/projects/"> <span>Projects</span></a>
				</li>
				<li>
					<a href="/categories/"> <span>Categories</span></a>
				</li>
		</li>
	</ul>
</div>

        <p>
		<section class="row text-center">
	
	<a href="https://twitter.com/palikar22"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://facebook.com/stanislav.ts"><i class="fab fa-facebook-f"></i></a>
	
	
	&nbsp;<a href="https://github.com/palikar"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	&nbsp;<a href="mailto:stanislav_ts@abv.bg"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

        </p>
		<p class="copyright">&copy; 2018 Stanislav Arnaudov.
        <a href="https://creativecommons.org/licenses/by/4.0">Some Rights Reserved</a>.<br/>Built with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
        </p>
	</div>
	<div>
	</div>
</div>

        <div class="content container">
            <div class="post">
  <h1>C&#43;&#43; Template Specialization</h1>
  
  <div class="col-sm-12 col-md-12">
    <span class="text-left post-date meta">
            
       
        <i class="fas fa-calendar-alt"></i> Jun 22, 2018
      
      
        
        
            in
            
            
                <a class="meta" href="/categories/github">GITHUB</a>
                
            
        
      
      
      
      <br/>
      <i class="fas fa-clock"></i> 7 min read 
      </span>  
  </div>    
  
  

<h2 id="abstract">Abstract</h2>

<p>C++ is awesome! I am starting stong here but it&rsquo;s really is. When experienced (and crazy) enough one can implement everything and the same one can do it icredibaly efficient at run time(cuz who cares how much work does the compiler do for us, amirite?). I can rant about how c++ is the best and all of the great features of the language but for this article I would constraint myself to one partzicular(but rather big) - template metaprogramming! Even more concreatly, I would like to show you a trick that I discovered myself that helped me solve one nasty problem. Yes, I admit, I am <del>probalby</del> certailty not the first one who discovers this trick <strong>BUT</strong> I promise you, I discovered it by myself and the whole prosess of discovering it was imensly satisfying. I mean&hellip;.templates <strong>are</strong> magic sometimes and I can only imagine how the people who understand them feel.</p>

<h2 id="the-problem">The problem</h2>

<p>Say you have a templated class that implements some kind of functionality and uses the type given by it&rsquo;s templete argument as some some soft of data. This probalby sound a little bit vague. A more concrete example of what I am talking about - imagine you have some class that sends some data to a server <em>somewhere</em>. The data can be std::string or int or double or some other random structure of yours. Of course the natural thing to come with that is a method <em>send(data)</em> that takes some data object of the templated type and does the <em>internal magic</em> (we don&rsquo;t care about that thou). In code everything will look something like:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">templete<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span>
{
  Sender(){}

  <span style="color:#902000">void</span> send(DataType data){...}

};
</code></pre></div>
<p>Pretty simple, pretty stright forward. To expand our hypotetical situation, imagine now that this is not your class but someone else&rsquo;s and other people are using it in it&rsquo;s current form. So you don&rsquo;t think about it all that much and go on to use the class yourself. After some while you find out that internaly the <em>send</em> function uses a field named <em>header</em> of the type you&rsquo;ve passed to the template of the class. For example you have something like this:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007020;font-weight:bold">template</span><span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
<span style="color:#902000">void</span> Sender<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;::</span>send(DataType data)
{
...
data.header <span style="color:#666">=</span> currentTime();
...
}
</code></pre></div>
<p>This automatically locks you to sending only structures that have a field named header(probalby also with time <em>unsigned int</em>). Not the biggest problem but again, let&rsquo;s make the situation complicated and say you have a project where you <strong>have</strong> to send a plain <em>std::string</em> to the server through this class (don&rsquo;t think about the situation too much, just roll with it and accept that I had very similar problem which I just could&rsquo;t avoid). So what do we have so far:</p>

<ul>
<li>someone else&rsquo;s templated class - we are not the designers</li>
<li>people are using it - no change of API is preferable</li>
<li>the template argument of the class expects a field <em>header</em></li>
<li>we <strong>have</strong> to send something without this <em>header</em> field</li>
</ul>

<p>And this is pretty much where I found myself that one time. The following explanations are the way how I solved the problem.</p>

<h2 id="tackling-it-probably-in-the-most-terrible-way">Tackling it probably in the most terrible way</h2>

<p>So, the way I did it was to add another template argument to the class - a booleand that specifies whether a <em>header</em> is used or not and then I hoped that a cn just specialize the <em>send</em> function with this new template argument set to <em>false</em> with a implementation withou use of <em>header</em>. Of course the default value of the new templete argument would be true for preserving backward compatability. The way I though it&rsquo;s gonna work as something like:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007020;font-weight:bold">template</span><span style="color:#666">&lt;</span>DataType, <span style="color:#902000">bool</span> header <span style="color:#666">=</span> <span style="color:#007020">true</span><span style="color:#666">&gt;</span>
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span>{...}

<span style="color:#007020;font-weight:bold">template</span><span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
<span style="color:#902000">void</span> Sender<span style="color:#666">&lt;</span>DataType, <span style="color:#007020">false</span><span style="color:#666">&gt;::</span>send(DataType data)
{
...
<span style="color:#60a0b0;font-style:italic">//data.header = currentTime();
</span><span style="color:#60a0b0;font-style:italic"></span>...
}

<span style="color:#007020;font-weight:bold">template</span><span style="color:#666">&lt;</span>DataType <span style="color:#902000">bool</span> header<span style="color:#666">&gt;</span>
<span style="color:#902000">void</span> Sender<span style="color:#666">&lt;</span>DataType, header<span style="color:#666">&gt;::</span>send(DataType data)
{
<span style="color:#60a0b0;font-style:italic">//default implementaion here
</span><span style="color:#60a0b0;font-style:italic"></span>...
data.header <span style="color:#666">=</span> currentTime();
...
}
</code></pre></div>
<p>Seemed logical at the time but couple of problems with that. By the implemetation of the function the <em>template&lt;&hellip;&gt;</em> is for the <em>Sender</em> class not for the function. This means that that all of the template arguments in the original declarations of the class have to be present there. Also when you think about it, there is no template function there to specialize, there is a templated class and the function is part of this class. After some more googling I found out that indeed, one cannot specialize member function of a templated class on some values of the template arguments. &ldquo;Okay, so I have to specialize the entire class&rdquo; I told myself. But then I would have to essentialy have the class twice with one little difference in this one function - one version with using <em>header</em> and one without. That&rsquo;s kind of dumb. Having almost the same code twice is dumb. This is why we have abstraction after all. Abstraction! Inheritance! So, how about that. I create a new class with two templeted arguments, I inherit the old class and pass the <em>DataType</em> argument to it and based on the second template I implent <em>send</em>. Again, make the <em>bool</em> default to <em>true</em> and name the new class the <em>Sender</em> so that the existing code base doesn&rsquo;t get broken. I would have something like this:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">templete<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SenderBase</span>
{
  Sender(){}

  <span style="color:#902000">void</span> send(DataType data){<span style="color:#60a0b0;font-style:italic">//no implementaion here}
</span><span style="color:#60a0b0;font-style:italic"></span>}
}
templete<span style="color:#666">&lt;</span>DataType, <span style="color:#902000">bool</span> header <span style="color:#666">=</span> <span style="color:#007020">true</span><span style="color:#666">&gt;</span>
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">public</span> SenderBase<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>{}

templete<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span><span style="color:#666">&lt;</span>DataType, <span style="color:#007020">true</span><span style="color:#666">&gt;</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">public</span> SenderBase<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
{
  <span style="color:#902000">void</span> send(DataType data)
    {
      ...
      <span style="color:#60a0b0;font-style:italic">//default implementaion
</span><span style="color:#60a0b0;font-style:italic"></span>      data.header <span style="color:#666">=</span> currentTime();
      ...
    }
}

templete<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span><span style="color:#666">&lt;</span>DataType, <span style="color:#007020">false</span><span style="color:#666">&gt;</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">public</span> SenderBase<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
{
  <span style="color:#902000">void</span> send(DataType data)
    {
      ...
      <span style="color:#60a0b0;font-style:italic">//no header version implementaion
</span><span style="color:#60a0b0;font-style:italic"></span>      <span style="color:#60a0b0;font-style:italic">//data.header = currentTime();
</span><span style="color:#60a0b0;font-style:italic"></span>      ...
    }
}
</code></pre></div>
<p>There, that <em>shoud</em> do it. Think about what is happening when a new object of the class gets created. If we have</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">Sender<span style="color:#666">&lt;</span>SomeDataType<span style="color:#666">&gt;</span> obj;
</code></pre></div>
<p>the second templated arguments defaults to true and the second versions gets instantiated. If, on the ohter hand, someone calls:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">Sender<span style="color:#666">&lt;</span>std<span style="color:#666">::</span>string, <span style="color:#007020">false</span><span style="color:#666">&gt;</span> obj;
</code></pre></div>
<p>the compiler generates the version withou the use of the <em>header</em> field and does not complaint because there is no such field in <em>std::string</em>. Perfect! One thing that bite me on the ass some time after I thought I &lsquo;fixed&rsquo; the class. Think about what would happen if the class uses internaly <em>send</em> for something. What happens if the client code is not the one who calls the <em>send</em> directly but the function call is made by other method that just passes the data to be send. This will be of course implemented in the base class <em>SenderBase</em> and this class sees only the emply implementaion of the <em>send</em> function. The fix is very simple if you know your language. We just make the <em>send</em> function virtual and allow the program to dispatch the right function call in runtime based of the type of the calling object. The final solution becomes:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">templete<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
   <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SenderBase</span>
   {
     Sender(){}

     <span style="color:#007020;font-weight:bold">virtual</span> <span style="color:#902000">void</span> send(DataType data) <span style="color:#666">=</span> <span style="color:#40a070">0</span>;
   }
   }
   templete<span style="color:#666">&lt;</span>DataType, <span style="color:#902000">bool</span> header <span style="color:#666">=</span> <span style="color:#007020">true</span><span style="color:#666">&gt;</span>
   <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">public</span> SenderBase<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>{}

   templete<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
   <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span><span style="color:#666">&lt;</span>DataType, <span style="color:#007020">true</span><span style="color:#666">&gt;</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">public</span> SenderBase<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
   {
     <span style="color:#007020;font-weight:bold">virtual</span> <span style="color:#902000">void</span> send(DataType data){...}
   }

   templete<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
   <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span><span style="color:#666">&lt;</span>DataType, <span style="color:#007020">false</span><span style="color:#666">&gt;</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">public</span> SenderBase<span style="color:#666">&lt;</span>DataType<span style="color:#666">&gt;</span>
   {
      <span style="color:#007020;font-weight:bold">virtual</span> <span style="color:#902000">void</span> send(DataType data){...}
   }
</code></pre></div>
<p>There! Now we have it. Now we&rsquo;ve (kinda) specialized a function of a templated class based on a value of a template argument without writing the whole class two times <strong>AND</strong> no previous user will notice this new feature of the class. It&rsquo;s not exactly a stright forward solution but I found it very elegant workaround.</p>

<h2 id="tackling-it-in-a-better-way">Tackling it in a better way</h2>

<p>But of course, a smimpler, more streight forward solution exists. Enter <em>enable_if</em> and class templates with added caviat. I mentioned - there is no template function so no use of SFINAE on deciding which function to pick. The thing is, templete classes can have template functions as members. So, there is no reason we can&rsquo;t do something like</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007020;font-weight:bold">template</span><span style="color:#666">&lt;</span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">DataType</span>, <span style="color:#902000">bool</span> Header <span style="color:#666">=</span> <span style="color:#007020">true</span><span style="color:#666">&gt;</span>
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sender</span>
{
  <span style="color:#007020;font-weight:bold">template</span><span style="color:#666">&lt;</span><span style="color:#902000">bool</span> Q <span style="color:#666">=</span> Header<span style="color:#666">&gt;</span>
  <span style="color:#007020;font-weight:bold">typename</span> std<span style="color:#666">::</span>enable_if<span style="color:#666">&lt;</span>Q, <span style="color:#902000">void</span><span style="color:#666">&gt;::</span>type send()
    {
      <span style="color:#60a0b0;font-style:italic">//use header here!
</span><span style="color:#60a0b0;font-style:italic"></span>    };
  <span style="color:#007020;font-weight:bold">template</span><span style="color:#666">&lt;</span><span style="color:#902000">bool</span> Q <span style="color:#666">=</span> Header<span style="color:#666">&gt;</span>
  <span style="color:#007020;font-weight:bold">typename</span> std<span style="color:#666">::</span>enable_if<span style="color:#666">&lt;!</span>Q, <span style="color:#902000">void</span><span style="color:#666">&gt;::</span>type send()
    {
      <span style="color:#60a0b0;font-style:italic">//do not use header here!
</span><span style="color:#60a0b0;font-style:italic"></span>    };
};
</code></pre></div>
<p>We again add the extra <em>header</em> template and based on it we pick one of two template functions <em>send</em>. It&rsquo;s important that they are in fact templete functions and not plain memeber functions of a templated class. Now when we instantiate the class with, one of those tow template functions is picked and compiler sees only it. Here you can even drop the <em>header</em> template parameter and work only with <em>enable_if</em> and some other template programming vodoo to detect whether DataType has field <em>header</em> or not. I&rsquo;ll leave that to you thou. Imortant note - this check has to be done though the <em>Q</em> template parameter of the functions because SFINAE applies only on it.</p>

</div>
            <div class="footer">
                <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

<script type="text/javascript">
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
</script>


        <h2>Comments</h2>
        <div id="disqus_thread"></div>
<script type="text/javascript">
      (function () {
            
            
            
            if (location.hostname === "localhost" || 
            	location.hostname === "127.0.0.1" || 
            	location.hostname === "") {
                return;
			}
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            var disqus_shortname = 'palikar-github-io';
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(
                  dsq);
      })();
</script>

<noscript>
	Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      

            </div>
        </div>
        
                
    </body>
</html>
