<!DOCTYPE html>
<html lang="en-us" prefix="og: http://ogp.me/ns#">
  
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.59.1" />





<title>Generic Execution Around Pointer â€¢ SA</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Generic Execution Around Pointer"/>
<meta name="twitter:description" content="A set of generic classes for constructing the execution-around-pointer idiom"/>

<meta property="og:title" content="Generic Execution Around Pointer" />
<meta property="og:description" content="A set of generic classes for constructing the execution-around-pointer idiom" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://palikar.github.io/posts/generic_execution_around_pointer/" />
<meta property="article:published_time" content="2019-12-05T00:12:08+01:00" />
<meta property="article:modified_time" content="2020-02-21T00:41:27+01:00" />


<title itemprop="name">Generic Execution Around Pointer | SA</title>
<meta property="og:title" content="Generic Execution Around Pointer | SA" />
<meta name="twitter:title" content="Generic Execution Around Pointer | SA" />
<meta itemprop="name" content="Generic Execution Around Pointer | SA" />
<meta name="application-name" content="Generic Execution Around Pointer | SA" />
<meta property="og:site_name" content="" />

<meta name="description" content="A set of generic classes for constructing the execution-around-pointer idiom" />
<meta itemprop="description" content="A set of generic classes for constructing the execution-around-pointer idiom" />
<meta property="og:description" content="A set of generic classes for constructing the execution-around-pointer idiom" />
<meta name="twitter:description" content="A set of generic classes for constructing the execution-around-pointer idiom" />

<base href="https://palikar.github.io/posts/generic_execution_around_pointer/">

<link rel="canonical" href="https://palikar.github.io/posts/generic_execution_around_pointer/" itemprop="url" /> 
<meta name="url" content="https://palikar.github.io/posts/generic_execution_around_pointer/" />
<meta name="twitter:url" content="https://palikar.github.io/posts/generic_execution_around_pointer/" /> 
<meta property="og:url" content="https://palikar.github.io/posts/generic_execution_around_pointer/" />
<meta property="og:locale" content="en">
<meta name="language" content="">


<meta itemprop="image" content="https://palikar.github.io/" />
<meta property="og:image" content="https://palikar.github.io/" />
<meta name="twitter:image" content="https://palikar.github.io/" />
<meta name="twitter:image:src" content="https://palikar.github.io/" /> 

<meta property="og:updated_time" content=2020-02-21T00:41:27&#43;0100 />
Sitemap & RSS Feed Tags
<link rel="sitemap" type="application/xml" title="Sitemap" href="https://palikar.github.io/sitemap.xml" /> 





<link rel="manifest" href="https://palikar.github.io/manifest.json" />


<meta name="theme-color" content="#141414" /> 
<meta name="msapplication-TileColor" content="#141414" />

<meta name="keywords" content="" />
<meta name="imagemode" content="force" />
<meta name="coverage" content="Worldwide" /> 
<meta name="distribution" content="Global" />
<meta name="HandheldFriendly" content="True" /> 
<meta name="msapplication-tap-highlight" content="no" />
<meta name="apple-mobile-web-app-title" content="" /> 
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-touch-fullscreen" content="yes" />

<meta name="twitter:site" content="">
<meta name="twitter:creator" content="" />

<meta name="google-site-verification" content="Dajyx2hCwYPHFFMX4gJOxXtv6swEnwmHw9cQz9pzJvg" />

    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="https://palikar.github.io/scss/hyde-hyde.b3b0c12be46e581537e5d3d1c4ca1fabaab21c72dcc8cb639a558c4b9a6f469e.css" integrity="sha256-s7DBK&#43;RuWBU35dPRxMofq6qyHHLcyMtjmlWMS5pvRp4=">


<link rel="stylesheet" href="https://palikar.github.io/scss/print.e5f87aa9d406c09ad1cb0284b65f42c7e53ea92dc1fe9b6ab366bba96a1344e9.css" integrity="sha256-5fh6qdQGwJrRywKEtl9Cx&#43;U&#43;qS3B/ptqs2a7qWoTROk=" media="print">




<link rel="stylesheet" href="https://palikar.github.io/scss/tocbot.126e7d75240acc946d34d6ccb2982ed4c394a5fe34e73e1a2119ca951bcf119d.css" integrity="sha256-Em59dSQKzJRtNNbMspgu1MOUpf405z4aIRnKlRvPEZ0=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://palikar.github.io/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://palikar.github.io/favicon.png">
    
    


    <meta charset="utf-8" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    
</head>


  <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://palikar.github.io/">SA</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://palikar.github.io/img/profile.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Development, CS, AI and whatever my little heart desires 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">SA</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="https://palikar.github.io/">
						<span>Home</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://palikar.github.io/portfolio/">
						<span>Portfolio</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://palikar.github.io/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://palikar.github.io/posts/">
						<span>Blog Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://palikar.github.io/projects/">
						<span>Projects</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://palikar.github.io/categories/">
						<span>Categories</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/palikar22" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://facebook.com/stanislav.ts" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/palikar" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/stanislav-arnaudov-37b475164" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="mailto:stanislav_ts@abv.bg" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    


  </div>
</div>

    <div class="content container">
      
    
<article>
  <header>
    <h1>Generic Execution Around Pointer</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Dec 5, 2019
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="https://palikar.github.io/categories/c&#43;&#43;">C&#43;&#43;</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="https://palikar.github.io/tags/c&#43;&#43;">c&#43;&#43;</a>
           
      
          <a class="badge badge-tag" href="https://palikar.github.io/tags/templates">templates</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>





  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
        <div class="toc" id="TableOfContents"></div>
      
    </div>
  
  
  <div class="post">
    

<h2 id="abstract">Abstract</h2>

<p>I recently found out what the <a href="https://en.wikibooks.org/wiki/More%5FC%252B%252B%5FIdioms/Execute-Around%5FPointer">Execute-Around_Pointer</a> idiom in C++ is. What it does is track access to a specific object. For example, when you want to observe how certain properties of an object change on each method call, you would employ the use of this idiom. Think of it like wrapping each method call for an object with additional function calls. This, for empale, is ugly code:</p>

<pre><code class="language-c++">std::vector&lt;int&gt; vec{1,2,3,4};

std::cout &lt;&lt; std::size(vec)
vec.push_back(5);
std::cout &lt;&lt; std::size(vec)

std::cout &lt;&lt; std::size(vec)
vec.push_back(6);
std::cout &lt;&lt; std::size(vec)
</code></pre>

<p>With the <code>Execute-Around_Pointer</code> you can &ldquo;prettify&rdquo; this pattern by constructing a special &ldquo;tracer&rdquo; object that internally keeps a reference to the vector. The underlying object is then accessed through the <code>-&gt;</code> operator. The code then can become:</p>

<pre><code class="language-c++">std::vector&lt;int&gt; vec{1,2,3,4};
VecotSizeTracer vec_tracer{vec};
vec_tracer-&gt;push_back(5);
vec_tracer-&gt;push_back(6);
</code></pre>

<p>On the wiki <a href="https://en.wikibooks.org/wiki/More%5FC%252B%252B%5FIdioms/Execute-Around%5FPointer">page</a> there is a similar example. The implementation there is, however, non-genric and does not use any templated code. I decided to write several classes that realize the logic of the idiom. Those can be then used to quickly construct different tracers for different types of types.</p>

<h2 id="making-it-generic">Making it generic</h2>

<h3 id="iterating-over-tuple">Iterating over tuple</h3>

<p>First off, we&rsquo;ll need one utility method. Namely, <code>for_each</code> for iterating over a tuple. Weirdly enough, there is no such method in the standard library. It&rsquo;s not that hard to implement something ourselves though:</p>

<pre><code class="language-c++">template&lt;std::size_t I = 0, typename FuncT, typename... Tp&gt;
inline std::enable_if_t&lt;I == sizeof...(Tp), void&gt;
for_each(std::tuple&lt;Tp...&gt; &amp;, FuncT)
{ }

template&lt;std::size_t I = 0, typename FuncT, typename... Tp&gt;
inline std::enable_if_t&lt;I &lt; sizeof...(Tp), void&gt;
for_each(std::tuple&lt;Tp...&gt;&amp; t, FuncT &amp;&amp; f)
{
    f(std::get&lt;I&gt;(t));
    for_each&lt;I + 1, FuncT, Tp...&gt;(t, std::forward&lt;FuncT&gt;(f));
};

</code></pre>

<p>Special thanks to <a href="https://stackoverflow.com/a/6894436">this</a> StackOverflow answer. The function just recursively loops over the tuple by keeping track of the current index in the <code>I</code> template parameter. The recursion is terminated when <code>I</code> is equal to the size of the tuple. If you&rsquo;ve programmed in Haskel, this should not be too hard for you.</p>

<h3 id="the-proxy-class">The proxy class</h3>

<p>Next, we need that class that can keep a pointer to an object as well as several other objects that will be notified when the pointer is accessed.</p>

<pre><code class="language-c++">template&lt;typename T, typename...Tracker&gt;
struct proxy
{
public:

    proxy(T&amp; obj, Tracker &amp;&amp; ... track) :
        m_obj(&amp;obj),
        m_track(std::forward&lt;decltype(track)&gt;(track)...)
    {
        (track.before(obj), ...);
    }

    ~proxy()
    {
        detail::for_each(m_track, [&amp;](auto&amp; tracker){tracker.after(*m_obj);});
    }

    T* operator -&gt;() { return m_obj;}
private:
    T* m_obj;
    std::tuple&lt;Tracker ...&gt; m_track;
};
</code></pre>

<p>The pointer is stored in the <code>m_obj</code> member. The notified objects are stored in the <code>m_track</code> tuple. Those can be of different types but must implement a <code>before</code> and a <code>after</code> method. The <code>before</code> methods of each object will be called before any operation on the object pointed by <code>m_obj</code> is performed, and the <code>after</code> method &ndash; after. We call the <code>after</code> method in the destructor by using our <code>for_each</code> function that we previously implemented. In the constructor, I&rsquo;ve simply used <a href="https://arne-mertz.de/2016/11/more-variadic-templates/">pack expansion</a>.</p>

<h3 id="the-tracer">The Tracer</h3>

<p>Now we have every that we need to write the final tracer class:</p>

<pre><code class="language-c++">template&lt;typename T, typename ...Tracker&gt;
class Tracked : public Tracker ...
{
  public :
    explicit Tracked(T&amp; obj) : m_obj(obj)
    {}

    detail::proxy&lt;T, Tracker...&gt; operator -&gt;() {
        return detail::proxy&lt;T, Tracker...&gt;(m_obj, static_cast&lt;Tracker&gt;(*this)...);
    }

  private :
    T&amp; m_obj;

};
</code></pre>

<p>On construction, the <code>Tracked</code> class takes the object that needs to be traced as well as several types &ndash; the <code>Tracker</code> variadic template argument. The <code>Tracker</code> class will be derived from each of the passed in types. This means that it will &ldquo;have&rdquo; all of the methods defined by the <code>Tracker</code> types. In the overload of the <code>-&gt;</code> operator, we create a proxy object with the underlying object and statically cast version of the <code>this</code> object with each of the given <code>Tracker</code> types. This is possible because we&rsquo;ve derived the <code>Tracked</code> from each of those types.</p>

<h3 id="usage">Usage</h3>

<p>With our defined classes, we can realize the logic of the Execute-Around-Pointer idiom in an easy manner. For example, if we want to track the size of a vector we can write something like:</p>

<pre><code class="language-c++">// class with before and after methods
class SizeTracker
{
    public:
    static void before(std::vector&lt;int&gt;&amp; vec) {
        std::cout &lt;&lt; &quot;Size Before:&quot; &lt;&lt; std::size(vec) &lt;&lt; &quot;\n&quot;;
    }

    static void after(std::vector&lt;int&gt;&amp; vec) {
        std::cout &lt;&lt; &quot;Size After:&quot; &lt;&lt; std::size(vec) &lt;&lt; &quot;\n&quot;;
    }
};

// tracker type for vector of ints.
using VectorSizeTracker = Tracked&lt;std::vector&lt;int&gt;, SizeTracker&gt;;
</code></pre>

<p>With this, we can rewrite the example that I gave at the beginning of the post.</p>

<pre><code class="language-c++">int main()
{
    std::vector&lt;int&gt; vec{1,2,3,4};
    VectorSizeTracker vec_track{vec};

    vec_track-&gt;push_back(5);
    vec_track-&gt;push_back(6);

    return 0;
}
</code></pre>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="https://palikar.github.io/posts/array_dim_deduction/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Multidimensional Array size deduction in C&#43;&#43;</span>
    </a>
    
    
</div>


  

  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'palikar-github-io';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


    </div>
    
    

<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/cmake.min.js"></script>
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/lisp.min.js"></script>
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/elisp.min.js"></script>
            
        
    
    <script type="text/javascript">
        
        hljs.configure({languages: ["cmake, lisp, elisp"]});
        
        hljs.initHighlightingOnLoad();
    </script>
    




<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.js"></script>
<script type="text/javascript">
  if (tocbot) {
    tocbot.init({
      
      tocSelector: '.toc',
      
      contentSelector: '.post',
      
      headingSelector: 'h2, h3, h4',
      collapseDepth: 4
    });
  }
</script>



    



  </body>
</html>
